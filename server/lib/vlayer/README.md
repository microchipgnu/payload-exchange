# VLayer Web Proof Integration

This module provides web proof generation and parsing functionality for proxy requests using the VLayer web prover service.

## Features

- **Automatic Proof Generation**: Generates cryptographic proofs for all proxy requests/responses
- **Database Storage**: Saves proofs and status codes to database for audit and analysis
- **Sponsor Access**: Sponsors can access proofs to verify resource health without accessing x402 responses
- **Failure Tracking**: Failed responses (5xx) are automatically tracked for resolution/refund requests
- **TypeScript Support**: Full type safety and IntelliSense support

## Configuration

Set the following environment variables:

```bash
VLAYER_API_ENDPOINT=https://your-vlayer-api-endpoint.com
VLAYER_CLIENT_ID=your-client-id
VLAYER_BEARER_TOKEN=your-bearer-token
```

If these are not set, VLayer proof generation will be skipped (proxy will still work normally).

## How It Works

1. **Proxy Request**: When a request comes through the proxy, it's forwarded to the resource provider
2. **Response Received**: After receiving the response from the resource provider
3. **Proof Generation**: VLayer generates a cryptographic proof of the request/response
4. **Database Storage**: The proof and status code are saved to the `response_proofs` table
5. **Sponsor Access**: Sponsors can query proofs via API endpoints

## Database Schema

The `response_proofs` table stores:
- `id`: Unique proof identifier
- `resourceId`: The resource being accessed
- `url`: Full URL that was requested
- `method`: HTTP method (GET, POST, etc.)
- `statusCode`: HTTP status code from response
- `statusText`: HTTP status text
- `proof`: Hex-encoded proof data
- `userId`: User who made the request (optional)
- `sponsorId`: Sponsor associated with the request (optional)
- `actionId`: Action associated with the request (optional)
- `metadata`: Additional metadata (JSON)
- `createdAt`: Timestamp

## API Endpoints for Sponsors

### GET /api/payload/sponsors/proofs

Get all response proofs for a sponsor.

**Headers:**
- `x-wallet-address`: Sponsor wallet address

**Query Parameters:**
- `limit`: Maximum number of proofs to return (default: 100)

**Response:**
```json
{
  "proofs": [
    {
      "id": "proof-id",
      "resourceId": "resource-id",
      "url": "https://example.com/api",
      "method": "GET",
      "statusCode": 200,
      "statusText": "OK",
      "proof": "hex-proof-data",
      "userId": "user-id",
      "actionId": "action-id",
      "metadata": {...},
      "createdAt": "2025-01-01T00:00:00Z"
    }
  ]
}
```

### GET /api/payload/sponsors/proofs/failed

Get failed response proofs (5xx status codes) for a sponsor. Useful for resolution/refund requests.

**Headers:**
- `x-wallet-address`: Sponsor wallet address

**Query Parameters:**
- `limit`: Maximum number of proofs to return (default: 100)

**Response:** Same format as `/proofs` endpoint, but only includes failed responses.

### GET /api/payload/sponsors/proofs/:id

Get a specific proof by ID.

**Headers:**
- `x-wallet-address`: Sponsor wallet address

**Response:**
```json
{
  "id": "proof-id",
  "resourceId": "resource-id",
  "url": "https://example.com/api",
  "method": "GET",
  "statusCode": 200,
  "statusText": "OK",
  "proof": "hex-proof-data",
  "userId": "user-id",
  "actionId": "action-id",
  "metadata": {...},
  "createdAt": "2025-01-01T00:00:00Z",
  "action": {
    "id": "action-id",
    "pluginId": "plugin-id",
    "coverageType": "full"
  }
}
```

## Usage Example

```typescript
import { VLayer } from '@/server/lib/vlayer';
import { parseWebProofHex } from '@/server/lib/vlayer/webproof-parser';

// VLayer is automatically initialized in proxy.ts
// Proofs are generated and saved automatically for all proxy requests

// To parse a proof:
const parsed = parseWebProofHex(proofHex);
console.log('Request URL:', parsed.request?.url);
console.log('Response status:', parsed.response?.statusCode);
console.log('Response body:', parsed.response?.bodyJson);
```

## Benefits

1. **Verification Without Tampering**: Sponsors can verify responses are correct without viewing or tampering with the response
2. **Resource Health Monitoring**: Sponsors can track resource health without accessing x402 responses
3. **Refund/Resolution Support**: Failed responses are automatically tracked for resolution and refund requests
4. **Audit Trail**: All requests/responses are cryptographically proven and stored

## Security Notes

⚠️ **Important**: This module performs no cryptographic verification. The web proofs are generated by the VLayer service, but for trust-minimized use cases, you should verify proofs on-chain or via vlayer precompiles.

The module is designed for:
- Off-chain analysis and debugging
- Building reputation systems
- Quality scoring for resource providers
- Development and testing workflows

For production use requiring cryptographic guarantees, implement proper verification mechanisms.

